# STM32知识点梳理分析

## 1.中断篇

### 1.什么是中断

​	CPU在执行当前程序时，因应系统出现的紧急情况而暂停，转而去执行处理紧急事件的特殊程序。处理完毕后，CPU会自动返回到原先暂停的程序中继续执行。这种因外界原因导致程序执行被打断的情况称为中断

### 2.STM32中断触发过程

1. **中断源触发**：外部设备触发相应中断源，系统检测到中断源触发
2. **中断控制器进行处理分析**：根据初始化时配置的中断源的抢占优先级和响应优先级，决定当前是否处理该中断以及是否由需要暂时挂起的其他优先级中断。
3. **查找中断处理函数地址**：CPU根据中断号，在中断向量表中进行查找相对应的中断处理函数。中断向量表维护在启动文件中，放置在Flash中（0x080000 + 4）。4是栈指针地址。如果有bootloader程序，则需要偏移中断向量表的位置。
4. **保存上下文**：系统将当前任务的寄存器值压栈，保存现场。
5. **执行中断服务程序**：CPU转而执行中断服务程序，执行该程序必须快进快出。且不可以调用不可重入函数。
6. **恢复现场**：执行完中断之后，将之前压栈的现场弹栈，已回复之前保存的现场。
7. **返回主程序**：中断程序执行之后，弹栈完成后，继续执行主程序

### 3.中断优先级

​	STM32中，中断分为抢占优先级与响应优先级，这两点在使用时需要遵循。

1. 第一，如果两个中断的抢占优先级和响应优先级都是一样的话，则看哪个中断先发生就先执行。		
2. 高优先级的抢占优先级是可以打断正在进行的低抢占优先级中断的，而抢占优先级相同的中断，高优先级的响应优先级中断不可以打断低响应优先级的中断。
3. 如果两个中断的 **抢占优先级不同**，那么 **抢占优先级高的中断** 将会先被处理，不论它们的 **响应优先级** 是否相同，**响应优先级相同** 只会在抢占优先级相同的情况下才起作用

### 4.中断优先级管理 

​	STM32中断是通过配置寄存器NVIC寄存器进行管理	，其中，`ISER`寄存器是一个中断使能寄存器组，支持256个中断，F103只用了其中的前60位。	若要使能某个中断，只需要将中断对应的`ISER`位置1即可。`ICER`寄存器，是一个中断除能寄存器组，位数与`ISER`寄存器相同，但是功能作用与其相反，若想要清除某个中断的使能，只需要将`ICER`寄存器中断对应的位置1即可。注意：对于NVIC的这些寄存器而言，都是写1有效，写0无效。与平常寄存器中写1使能，写0失能不同。

​	寄存器`IP`：全称是：Interrupt Priority Registers，是一个中断优先级控制的寄存器组，这是一个数组，控制着M3内核的256个中断，数组类型为`uint8_t`,而每个可屏蔽中断占用的8bit并没有全部使用，而是 只用了高4位,这4位，又分为抢占优先级和子优先级。抢占优先级在前，子优先级在后。这里说明的子优先级就是上边提到的响应优先级。这两个优先级各占几个位又要根据SCB->AIRCR中的中断分组设置来决定。

​	这里简单介绍一下STM32的中断分组：STM32将中断分为5个组，组0~4。该分组的设置是由SCB->AIRCR寄存器的bit10~8来定义的。

| 组    | AIRCR[10：8] | bit[7：4]分配情况 | 分配结果             |      |      |
| ---- | ----------- | ------------ | ---------------- | ---- | ---- |
| 0    | 111         | 0：4          | 0 位抢占优先级，4位响应优先级 |      |      |
| 1    | 110         | 1：3          | 1 位抢占优先级，3位响应优先级 |      |      |
| 2    | 101         | 2：2          | 2 位抢占优先级，2位响应优先级 |      |      |
| 3    | 100         | 3：1          | 3 位抢占优先级，1位响应优先级 |      |      |
| 4    | 011         | 4：0          | 4 位抢占优先级，0位响应优先级 |      |      |

​	通过这个表，我们就可以清楚的看到组0~4对应的配置关系，例如组设置为3，那么此时
所有的60个中断，每个中断的中断优先寄存器的高四位中的最高3位是抢占优先级，低1位是
响应优先级。每个中断，你可以设置抢占优先级为0~7，响应优先级为1或0。抢占优先级的
级别高于响应优先级。而数值越小所代表的优先级就越高。